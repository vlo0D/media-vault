services:
  minio:
    image: minio/minio:latest
    container_name: media-vault-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - ./.minio/data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio-setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-media-vault}
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        until mc alias set local http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin}; do sleep 1; done
        mc mb -p local/$${S3_BUCKET_NAME:-media-vault} || true
        mc anonymous set public local/$${S3_BUCKET_NAME:-media-vault}
        printf '<?xml version="1.0" encoding="UTF-8"?>\n<CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">\n  <CORSRule>\n    <AllowedOrigin>*</AllowedOrigin>\n    <AllowedMethod>GET</AllowedMethod>\n    <AllowedMethod>POST</AllowedMethod>\n    <AllowedMethod>PUT</AllowedMethod>\n    <AllowedMethod>DELETE</AllowedMethod>\n    <AllowedMethod>HEAD</AllowedMethod>\n    <MaxAgeSeconds>3000</MaxAgeSeconds>\n  </CORSRule>\n</CORSConfiguration>\n' > /tmp/cors-simple.xml
        mc cors set local/$${S3_BUCKET_NAME:-media-vault} /tmp/cors-simple.xml 2>&1 || echo "CORS setup skipped (may need manual configuration)"
        echo "Bucket setup completed (public access enabled for development)"

